
*大前提*
[Centos7 Activedrectory](./activedrectory.md) 構築済み前提で進めます。

## 事前準備

```bash
#hostname 変更
$echo member > /etc/hostname

#※DNS
$vi /etc/sysconfig/network-scripts/ifcfg-ens33

#hosts
#追記
$echo 192.168.1.33 centosdc01 >> /etc/hosts

$systemctl restart network

#確認
$cat /etc/resolv.conf
```

*/etc/sysconfig/network-scripts/ifcfg-ens33*
```yml
TYPE="Ethernet"
PROXY_METHOD="none"
BROWSER_ONLY="no"
BOOTPROTO="dhcp"
DEFROUTE="yes"
IPV4_FAILURE_FATAL="no"
IPV6INIT="yes"
IPV6_AUTOCONF="yes"
IPV6_DEFROUTE="yes"
IPV6_FAILURE_FATAL="no"
IPV6_ADDR_GEN_MODE="stable-privacy"
NAME="ens33"
UUID="07a31889-2c9a-4fda-ad17-4582f6f3e7fc"
DEVICE="ens33"
ONBOOT="yes"
#追加
DNS1=192.168.1.33
```

## Sambaインストール用パッケージの導入

```bash
$yum -y install samba-winbind samba-winbind-clients
```

## ドメイン参加

```bash
#※ 認証設定
$authconfig-tui

$net ads info
$vi /etc/samba/smb.conf

```

*authconfig-tui*
認証設定
- 認証の設定
  - ユーザー情報
    - Winbindを使用
  - 認証
    - シャドウパスワードを使用
    - Winbind認証を使用
    - ローカル認証は十分です
- Winbind設定
  - セキュリティモデル
    - ads
  - ドメイン
    - CENTOS
  - ドメインコントローラ(ドメインコントローラーのホスト名)
    - centosdc01
  - ADSレルム（Realm)
    - CENTOS.LOCAL
  - ドメイン参加押下

## ドメイン確認

```bash
$net ads join -U Administrator
    Enter Administrators password:
    Using short domain name -- CENTOS
    Joined 'MEMBER' to dns domain 'centos.local'
    No DNS domain configured for member. Unable to perform DNS Update.
    DNS update failed: NT_STATUS_INVALID_PARAMETER

#ドメイン参加確認
$net ads info
    LDAP server: 192.168.1.33
    LDAP server name: centosdc01.centos.local
    Realm: CENTOS.LOCAL
    Bind Path: dc=CENTOS,dc=LOCAL
    LDAP port: 389
    Server time: 月, 07  3月 2022 22:38:49 JST
    KDC server: 192.168.1.33
    Server time offset: 0
    Last machine account password change: 月, 07  3月 2022 14:27:51 JST

#ユーザー一覧表示
$wbinfo -u
CENTOS\administrator
CENTOS\centos01
CENTOS\norihito
CENTOS\krbtgt
CENTOS\guest
```

#Winbind設定
Active Directoryドメイン上のユーザーをLinuxユーザーとして使用できるように以下の設定を行う。
- シェルを利用できるようにする
- ホームディレクトリを「/home/ユーザー名」にする
- ユーザー名を「ドメイン名\ユーザー名」ではなく「ユーザー名」にする

```bash
#※
$vi /etc/samba/smb.conf
$systemctl restart winbind
$wbinfo -u

$authconfig --enablemkhomedir --update

$chmod 1777 /home/


#user:norihito でログインできるようにする
$mkdir /home/norihito

```


*/etc/samba/smb.conf*
```yml
# See smb.conf.example for a more detailed config file or
# read the smb.conf manpage.
# Run 'testparm' to verify the config is correct after
# you modified it.

[global]
#--authconfig--start-line--

# Generated by authconfig on 2022/03/05 21:33:41
# DO NOT EDIT THIS SECTION (delimited by --start-line--/--end-line--)
# Any modification may be deleted or altered by authconfig in future

   workgroup = CENTOS
   password server = centosdc01
   realm = CENTOS.LOCAL
   security = ads
   idmap config * : range = 16777216-33554431
   template homedir = /home/%U

   # START ここから追加
   template shell = /bin/bash
   kerberos method = secrets only
   winbind use default domain = true
   winbind offline logon = false
   # END

#--authconfig--end-line--
;       workgroup = SAMBA
;       security = user

        passdb backend = tdbsam

        printing = cups
        printcap name = cups
        load printers = yes
        cups options = raw

[homes]
        comment = Home Directories
        #valid users = %S, %D%w%S
        browseable = No
        #read only = No
        #inherit acls = Yes
        writable = yes
        # START ここから追加
        #root preexec = /usr/local/sbin/mkhomedir.sh %U
        # END

[printers]
        comment = All Printers
        path = /var/tmp
        printable = Yes
        create mask = 0600
        browseable = No

[print$]
        comment = Printer Drivers
        path = /var/lib/samba/drivers
        write list = @printadmin root
        force group = @printadmin
        create mask = 0664
        directory mask = 0775
```

- [Sambaドメインメンバのトラブルシューティング](https://www.rough-and-cheap.jp/mediawiki/Sambaドメインメンバのトラブルシューティング)